<div class="app-container">
  <header class="app-header">
    <div class="header-content">
      <h1>📅 File to Calendar Converter</h1>
      <p>Convert images and PDFs to ICS calendar files</p>
    </div>
    <!-- Only show auth component in header when user is connected -->
    <div *ngIf="user$ | async" class="header-auth">
      <app-auth mode="header"></app-auth>
    </div>
  </header>

  <!-- Authenticated user view -->
  <main class="app-main" *ngIf="user$ | async">
    <div class="main-content-layout" *ngIf="!showResults">
      <!-- File upload section -->
      <div class="converter-section">
        <app-file-upload (textExtracted)="onTextExtracted($event)"> </app-file-upload>
      </div>
    </div>

    <div class="results-section" *ngIf="showResults && extractedText">
      <div class="events-card" *ngIf="parsedEvents.length > 0">
        <div class="events-header">
          <h2>📅 Calendar Events ({{ parsedEvents.length }})</h2>
        </div>

        <div class="events-list iphone-style" #eventsList>
          <div
            class="event-item"
            *ngFor="let event of parsedEvents; trackBy: trackEvent; let i = index"
            [attr.data-color-index]="i % 3"
          >
            <!-- Date card on the left -->
            <div class="date-card">
              <div class="day-abbreviation">{{ getDayAbbreviation(event.startDate) }}</div>
              <div class="day-number">{{ event.startDate | date: 'd' }}</div>
            </div>

            <!-- Colored accent border -->
            <div class="accent-border" [attr.data-color]="getEventColor(i)"></div>

            <!-- Event content -->
            <div class="event-content">
              <div class="event-main">
                <div class="event-info">
                  <h3 class="event-title">{{ event.title }}</h3>
                  <p class="event-location" *ngIf="event.location">
                    <span class="location-icon">📍</span>{{ event.location }}
                  </p>
                  <p
                    class="event-description"
                    *ngIf="event.description && event.description !== event.title"
                  >
                    {{ event.description }}
                  </p>
                </div>

                <div class="event-time">
                  <div class="time-start">{{ event.startDate | date: 'HH:mm' }}</div>
                  <div class="time-end">{{ event.endDate | date: 'HH:mm' }}</div>
                  <div
                    class="confidence-badge"
                    *ngIf="event.confidence"
                    [class]="getConfidenceClass(event.confidence)"
                  >
                    {{ (event.confidence * 100).toFixed(0) }}%
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button
            class="download-btn"
            (click)="downloadCalendar()"
            [disabled]="isDownloading"
            [class.downloading]="isDownloading"
          >
            <span *ngIf="!isDownloading">📥 Download Calendar (.ics)</span>
            <span *ngIf="isDownloading">⏳ Preparing Download...</span>
          </button>
          <button class="reset-btn" (click)="resetConverter()">🔄 Convert Another File</button>
        </div>

        <div
          class="download-status"
          *ngIf="downloadStatus"
          [class]="'status-' + downloadStatus.type"
        >
          <div class="status-message">
            <span class="status-icon">
              {{
                downloadStatus.type === 'success'
                  ? '✅'
                  : downloadStatus.type === 'error'
                    ? '❌'
                    : 'ℹ️'
              }}
            </span>
            {{ downloadStatus.message }}
          </div>
        </div>
      </div>

      <div class="no-events-card" *ngIf="parsedEvents.length === 0">
        <h2>⚠️ No Calendar Events Detected</h2>
        <div class="no-events-explanation">
          <p class="main-message">
            We couldn't detect any calendar events in the extracted text. This can happen for several reasons:
          </p>
          <div class="troubleshooting">
            <h3>💡 Tips for better results:</h3>
            <ul class="tips-list">
              <li><strong>Date Format:</strong> Ensure dates are clearly written (e.g., "March 15, 2024" or "15/03/2024")</li>
              <li><strong>Time Information:</strong> Include specific times (e.g., "2:00 PM" or "14:00")</li>
              <li><strong>Event Details:</strong> Have clear event titles and descriptions</li>
              <li><strong>Image Quality:</strong> Use high-resolution, well-lit images with clear text</li>
              <li><strong>Text Orientation:</strong> Ensure text is not rotated or skewed</li>
            </ul>
          </div>
          <div class="example-formats">
            <h3>📋 Example formats we recognize:</h3>
            <ul class="format-examples">
              <li>"Meeting on March 15, 2024 at 2:00 PM"</li>
              <li>"Conference: April 20th, 10:00 AM - 5:00 PM"</li>
              <li>"Appointment scheduled for 03/25/2024 at 3:30 PM"</li>
            </ul>
          </div>
        </div>
        <div class="extraction-info" *ngIf="extractedText.confidence">
          <p class="confidence-info">
            <span class="confidence-label">Text Extraction Confidence:</span>
            <span class="confidence-value" [class]="getConfidenceClass(extractedText.confidence)">
              {{ (extractedText.confidence * 100).toFixed(0) }}%
            </span>
          </p>
          <p class="confidence-help" *ngIf="extractedText.confidence < 0.8">
            <em>Low confidence may indicate poor image quality or unclear text. Try uploading a clearer image.</em>
          </p>
        </div>
        <button class="reset-btn" (click)="resetConverter()">🔄 Try Another File</button>
      </div>
    </div>
  </main>

  <!-- Non-authenticated user view -->
  <div class="login-layout" *ngIf="!(user$ | async)">
    <div class="auth-section">
      <div class="auth-content">
        <h2>🔐 Authentication Required</h2>
        <p class="main-message">Please sign in with Google to use the file converter</p>
        
        <div class="auth-info-grid">
          <div class="auth-reasons">
            <h3>Why do we require authentication?</h3>
            <div class="auth-benefits-grouped">
              <div class="benefit-item">
                <span class="benefit-icon">🔒</span>
                <div class="benefit-content">
                  <strong>Security:</strong> Protect your uploaded documents and ensure privacy
                </div>
              </div>
              <div class="benefit-item">
                <span class="benefit-icon">⚡</span>
                <div class="benefit-content">
                  <strong>Processing Power:</strong> Access to advanced OCR and AI processing capabilities
                </div>
              </div>
              <div class="benefit-item">
                <span class="benefit-icon">📁</span>
                <div class="benefit-content">
                  <strong>File History:</strong> Keep track of your conversion history (optional)
                </div>
              </div>
              <div class="benefit-item">
                <span class="benefit-icon">⏱️</span>
                <div class="benefit-content">
                  <strong>Rate Limiting:</strong> Prevent abuse and ensure fair usage for all users
                </div>
              </div>
            </div>
            <p class="privacy-note">
              <em>Your documents are processed securely and are not stored permanently on our servers.</em>
            </p>
          </div>
          
          <div class="process-overview">
            <h3>How It Works</h3>
            <div class="process-steps-grouped">
              <div class="process-item">
                <span class="process-icon">📤</span>
                <div class="process-content">
                  <strong>Upload Your Document:</strong> Drag and drop images (JPG, PNG) or PDF files
                </div>
              </div>
              <div class="process-item">
                <span class="process-icon">🔍</span>
                <div class="process-content">
                  <strong>OCR Text Extraction:</strong> Advanced technology reads and extracts text with high accuracy
                </div>
              </div>
              <div class="process-item">
                <span class="process-icon">🧠</span>
                <div class="process-content">
                  <strong>Smart Event Detection:</strong> AI algorithms identify event titles, dates, times, and locations
                </div>
              </div>
              <div class="process-item">
                <span class="process-icon">📅</span>
                <div class="process-content">
                  <strong>Calendar Generation:</strong> Generate downloadable ICS files compatible with all major calendar apps
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <app-auth mode="login"></app-auth>
      </div>
    </div>
    
    <!-- Content expansion section - beside auth -->
    <div class="content-expansion-section">
      <div class="info-card">
        <h2>About File to Calendar Converter</h2>
        <div class="description-content">
          <p class="process-description">
            Upload images or PDF files containing event information, and our intelligent system will automatically detect dates, times, locations, and event details to create downloadable calendar files compatible with Google Calendar, Outlook, and Apple Calendar.
          </p>
          <div class="supported-formats">
            <span class="format-label">Supported formats:</span>
            <span class="formats">JPG, PNG, PDF</span> • 
            <span class="output-label">Output:</span>
            <span class="output">ICS Calendar Files</span>
          </div>
        </div>
        
        <div class="features-list">
          <h3>✨ Key Features</h3>
          <ul>
            <li><strong>📤 Easy Upload:</strong> Drag-and-drop interface for images and PDF files</li>
            <li><strong>🔍 Advanced OCR:</strong> High-accuracy text extraction from documents</li>
            <li><strong>🧠 Smart Detection:</strong> AI-powered event information recognition</li>
            <li><strong>📅 Universal Format:</strong> Creates ICS files compatible with all major calendar apps</li>
            <li><strong>📱 Mobile Friendly:</strong> Responsive design works on all devices</li>
            <li><strong>🔐 Secure Processing:</strong> Your documents are processed safely and privately</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<router-outlet></router-outlet>
